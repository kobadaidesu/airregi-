# AirREGI ヘルプデスク入電数予測
## 仮定（Hypothesis）と特徴量設計（Feature Engineering）の包括的ドキュメント

---

## 📊 データセット概要

| 項目 | 内容 |
|------|------|
| 期間 | 2018/06/01 - 2020/03/31 (670日間) |
| 目的変数 | call_num (ヘルプデスク入電数) |
| 営業日数 | 478日（平日のみ営業） |
| 平均入電数 | 163.3件/日（平日） |
| 最大入電数 | 757件（2019/09/25） |

---

## 🔬 分析から得られた主要な発見

### 1. 強い要因
- **アカウント取得数との相関**: r = 0.712（非常に強い）
- **CM施策の効果**: +28.9%（150.4件→193.8件）
- **消費税増税の影響**: 前年比425%（2019年9月）

### 2. 季節性
- **最繁忙月**: 9月（284.9件）
- **最閑散月**: 1月（70.9件）
- **四半期差**: Q1=104.9件 vs Q3=207.4件

### 3. 異常値
- **2019年1月**: 平日23日中18日がゼロ（データ品質問題の可能性）
- **2019年9月**: 消費税増税前の駆け込み需要

---

## 📋 仮定（Hypothesis）一覧

### カテゴリA: 時系列・自己相関に関する仮定（8個）

| ID | 仮定 | 根拠 | 検証方法 |
|----|------|------|----------|
| A-1 | 入電数には強い1次自己相関がある | 自己相関係数 ラグ1=0.683 | ラグ特徴量の重要度 |
| A-2 | 週単位の季節性がある | 5日周期の相関=0.565 | 週次ラグの重要度 |
| A-3 | 短期の移動平均がトレンドを捉える | トレンド除去で標準偏差減少 | MA特徴量の重要度 |
| A-4 | 短期の変動（ボラティリティ）が予測に有用 | 変動率>50%の日が73日 | STD特徴量の重要度 |
| A-5 | 前日からの変化量が予測に有用 | 1次差分ラグ1相関=-0.427 | 差分特徴量の重要度 |
| A-6 | 長期トレンドがある | 経過日数との相関=0.277 | トレンド特徴量の重要度 |
| A-7 | 週の前半と後半で傾向が異なる | 月曜154.3件 vs 木曜166.5件 | 曜日フラグの重要度 |
| A-8 | 週次・月次の周期性がある | 週次自己相関=0.700 | 周期特徴量の重要度 |

### カテゴリB: カレンダー・季節性に関する仮定（13個）

| ID | 仮定 | 根拠 | 検証方法 |
|----|------|------|----------|
| B-1 | 月によって入電数が大きく異なる | 1月70.9件 vs 9月284.9件 | 月別平均の差の検定 |
| B-2 | 四半期によって傾向が異なる | Q1=104.9件 vs Q3=207.4件 | 四半期フラグの重要度 |
| B-3 | 曜日によって入電パターンが異なる | 月曜154.3件 vs 火〜金165件 | 曜日別平均の検定 |
| B-4 | 休日（土日祝）は入電がゼロ | 休日平均=0.0件 | 必須フラグとして使用 |
| B-5 | 祝日の前日は入電パターンが変わる | 祝日前158.1件 vs 通常164.8件 | 祝日前フラグの重要度 |
| B-6 | 連休明けは入電パターンが異なる | 連休明け154.3件 vs 通常165.5件 | 連休明けフラグの重要度 |
| B-7 | 月末は入電が増加する | 月末182.3件 vs その他158.0件 | 月末フラグの重要度 |
| B-8 | 月初は入電が増加する | 月初180.0件 vs その他160.0件 | 月初フラグの重要度 |
| B-9 | 25日（給料日）は特に入電が多い | 25日215.1件 vs その他161.4件 | 25日フラグの重要度 |
| B-10 | 年末年始は特殊なパターン | 年末年始平均86.8件 | 年末年始フラグの重要度 |
| B-11 | ゴールデンウィークは特殊 | GW期間は祝日扱い | GWフラグの重要度 |
| B-12 | お盆期間は入電パターンが異なる | お盆中の入電変動 | お盆フラグの重要度 |
| B-13 | 年度末・年度初めは特殊 | 決算対応の問い合わせ | 年度フラグの重要度 |

### カテゴリC: CM施策に関する仮定（8個）

| ID | 仮定 | 根拠 | 検証方法 |
|----|------|------|----------|
| C-1 | CM施策は入電数を増加させる | CM有193.8件 vs 無150.4件(+28.9%) | CM効果の因果推論 |
| C-2 | CM効果は曜日によって異なる | 月曜は差なし、火〜金は差大 | 交互作用項の重要度 |
| C-3 | CM効果は季節によって異なる | Q3でCM効果+108% | 四半期別CM効果の比較 |
| C-4 | CM効果は累積する | 連続実施で入電増加傾向 | CM連続日数の重要度 |
| C-5 | CMには残存効果がある | CM終了後1日目145.3件 | CMラグ特徴量の重要度 |
| C-6 | CM頻度が効果に影響 | 月別CM実施日数の差 | CM累計特徴量の重要度 |
| C-7 | CM×アカウント取得の相乗効果 | CM×High acc=264.0件 | 交互作用項の重要度 |
| C-8 | CM×Google Trendsの相乗効果 | CM×High GT=251.0件 | 交互作用項の重要度 |

### カテゴリD: アカウント取得に関する仮定（9個）

| ID | 仮定 | 根拠 | 検証方法 |
|----|------|------|----------|
| D-1 | アカウント取得は入電と強い相関 | r=0.712 | 特徴量重要度 |
| D-2 | 効果は翌日以降にも現れる | ラグ1日r=0.634 | ラグ特徴量の比較 |
| D-3 | 移動平均がトレンドを捉える | 週次相関=0.772 | MA特徴量の重要度 |
| D-4 | 急増は入電急増を予測 | 急増日と入電の関連 | 急増フラグの重要度 |
| D-5 | レベルにより入電が異なる | Q1=101件 vs Q4=255件 | 四分位フラグの重要度 |
| D-6 | 関係は非線形 | 2乗項r=0.577 | 非線形項の重要度 |
| D-7 | 季節との交互作用あり | Q3×High=318.4件 | 交互作用項の重要度 |
| D-8 | CMがアカウント増加を媒介 | CM時acc平均=1.014 | 媒介分析 |
| D-9 | 1-2週間後に問い合わせ | オンボーディング仮説 | 累積効果の検証 |

### カテゴリE: Google Trendsに関する仮定（8個）

| ID | 仮定 | 根拠 | 検証方法 |
|----|------|------|----------|
| E-1 | 検索量は入電と正の相関 | 日次r=0.316、週次r=0.377 | 特徴量重要度 |
| E-2 | 効果は1週間遅れで現れる | ラグ1週r=0.480 | ラグ特徴量の比較 |
| E-3 | 移動平均がトレンドを捉える | 週次データの平滑化 | MA特徴量の重要度 |
| E-4 | 変化が予測に有用 | 検索量急増時の入電増加 | 変化特徴量の重要度 |
| E-5 | レベルにより入電が異なる | Q1=132件 vs Q4=209件 | 四分位フラグの重要度 |
| E-6 | CMとの相乗効果あり | CM×High GT=251件 | 交互作用項の重要度 |
| E-7 | 検索量は季節性を持つ | 9月47.9 vs 6月28.2 | 季節調整の効果 |
| E-8 | ピーク/ボトムは重要シグナル | 検索量100で入電2692件/週 | ピークフラグの重要度 |

### カテゴリF: 特殊イベントに関する仮定（8個）

| ID | 仮定 | 根拠 | 検証方法 |
|----|------|------|----------|
| F-1 | 消費税増税が入電を大幅増加 | 2019年9月は前年比425% | 増税特徴量の重要度 |
| F-2 | キャッシュレス還元も影響 | 決済関連問い合わせ増 | 還元期間フラグの重要度 |
| F-3 | 2019年1月は異常値 | CM実施でも入電ゼロ10日 | 異常値フラグの効果 |
| F-4 | 大型連休前後は特殊 | 年末年始平均86.8件 | 連休フラグの重要度 |
| F-5 | iOSアップデートで問い合わせ増 | iPadアプリの互換性 | iOS更新期間の重要度 |
| F-6 | 確定申告期間に入電増加 | 個人事業主の売上集計 | 申告期間フラグの重要度 |
| F-7 | 月次決算日に問い合わせ増 | 25日215.1件 vs その他161.4件 | 決算日フラグの重要度 |
| F-8 | 軽減税率導入も入電増加要因 | 2019年10月同時導入 | 軽減税率フラグの重要度 |

### カテゴリG: ドメイン知識に関する仮定（8個）

| ID | 仮定 | 根拠 | 検証方法 |
|----|------|------|----------|
| G-1 | 飲食店繁忙期に問い合わせ増 | ユーザーの40%が飲食店 | 繁忙期フラグの重要度 |
| G-2 | 小売業繁忙期に問い合わせ増 | ユーザーの25%が小売店 | セール期間フラグの重要度 |
| G-3 | 美容業繁忙期に問い合わせ増 | ユーザーの20%が美容業 | 成人式前フラグの重要度 |
| G-4 | 導入後1-2週間は問い合わせ多 | オンボーディング期間 | 遅延効果の検証 |
| G-5 | 周辺機器トラブルは温度・湿度影響 | Bluetooth接続不良 | 季節フラグの重要度 |
| G-6 | 決済トラブルは繁忙期に多発 | 高負荷時のエラー | 繁忙期×決済の交互作用 |
| G-7 | 複数サービス利用者は問い合わせ多 | 連携問題の発生 | サービス複雑度の推定 |
| G-8 | 営業形態で問い合わせパターン異なる | 昼営業vs夜営業 | 曜日パターンの分析 |

### カテゴリH: 不確実性に関する仮定（3個）

| ID | 仮定 | 根拠 | 検証方法 |
|----|------|------|----------|
| H-1 | ばらつき大きい時期は予測困難 | 9月STD=219.5 | ボラティリティと誤差の関係 |
| H-2 | 外部イベントで予測精度低下 | 増税時は予測困難 | イベント期間の誤差分析 |
| H-3 | データ欠損期間前後は信頼性低 | 2019年1月の異常 | 異常期間近傍の誤差分析 |

---

## 🛠️ 特徴量設計（Feature Engineering）

### 生成された特徴量の総数: 142個

### カテゴリ別特徴量一覧

#### A. 時系列・自己相関特徴量（29個）

```python
# ラグ特徴量
call_lag1, call_lag2, call_lag3, call_lag5, call_lag7, call_lag14, call_lag21, call_lag30

# 移動平均特徴量
call_ma3, call_ma5, call_ma7, call_ma14, call_ma30

# ボラティリティ特徴量
call_std3, call_std7, call_std14, call_cv7

# 差分特徴量
call_diff1, call_diff_ma3

# トレンド特徴量
days_from_start, days_from_start_log

# 周期性特徴量
day_of_week_sin, day_of_week_cos
week_of_year, week_of_year_sin, week_of_year_cos
day_of_year, day_of_year_sin, day_of_year_cos
```

#### B. カレンダー・季節性特徴量（60個）

```python
# 月関連
month, month_sin, month_cos
is_month_1 ~ is_month_12 (12個)

# 四半期関連
quarter, is_q1, is_q2, is_q3, is_q4

# 曜日関連
is_monday, is_tuesday, is_wednesday, is_thursday, is_friday
is_weekend, is_holiday, is_open_day_calc

# 月内位置
day, is_month_end, is_last_5_days, is_month_start, is_first_3_days
is_day_25, is_around_payday

# 年内特殊期間
is_year_end, is_year_start, is_new_year_period
is_golden_week, is_obon, is_around_obon
is_fiscal_year_end, is_fiscal_year_start
```

#### C. CM施策特徴量（25個）

```python
# CM×曜日交互作用
cm_x_monday, cm_x_tuesday, cm_x_wednesday, cm_x_thursday, cm_x_friday

# CM×四半期交互作用
cm_x_q1, cm_x_q2, cm_x_q3, cm_x_q4

# CM連続実施
cm_streak, cm_streak_log, cm_streak_squared, is_cm_streak_long

# CMラグ・残存効果
cm_lag1, cm_lag2, cm_lag3, cm_lag5, cm_lag7
cm_days_since, cm_recency_decay

# CM頻度
cm_count_last7, cm_count_last14, cm_count_last30, cm_ratio_last14

# CM×アカウント交互作用
cm_x_acc_continuous
```

#### D. アカウント取得特徴量（21個）

```python
# ラグ特徴量
acc_lag1, acc_lag2, acc_lag3, acc_lag5, acc_lag7, acc_lag14

# 移動平均特徴量
acc_ma3, acc_ma5, acc_ma7, acc_ma14, acc_ma30

# 変化量特徴量
acc_diff, acc_diff_ma3

# 非線形変換
acc_squared

# 四半期交互作用
acc_x_q1, acc_x_q2, acc_x_q3, acc_x_q4

# 累積効果
acc_cumsum_last7, acc_cumsum_last14
```

#### E. Google Trends特徴量（7個）

```python
search_cnt_scaled
search_lag1w, search_lag2w, search_lag3w, search_lag4w
search_diff
search_x_cm
```

#### F. 特殊イベント特徴量（7個）

```python
# 消費税増税関連
days_to_tax_increase, days_from_tax_increase
is_pre_tax_increase_month, is_pre_tax_increase_2weeks
is_post_tax_increase_month

# 異常値期間
is_jan_2019

# 確定申告
is_tax_filing_period
```

#### G. ドメイン知識特徴量（4個）

```python
is_bonenkai_season, is_restaurant_peak
is_bonus_month
is_summer, is_winter, season
```

#### H. 不確実性特徴量（2個）

```python
historical_volatility
is_high_volatility_period
```

#### I. 複合特徴量（3個）

```python
marketing_intensity
above_ma7
trend_direction
```

---

## ⚠️ リーケージ防止のための注意点

### 使用禁止（リーケージの原因となる特徴量）

1. **当日のデータを使った特徴量**
   - 当日のアカウント取得数（予測時点で未知）
   - 当日のGoogle Trends値（更新タイミングに注意）

2. **未来のデータを使った移動平均**
   - 中央移動平均（前後両方を使う）
   - 将来の祝日情報を使った特徴量

3. **目的変数を使った統計量**
   - テスト期間を含めた月別平均
   - テスト期間を含めた曜日別平均

### 安全な特徴量

✅ 過去のデータのみを使ったラグ特徴量  
✅ 過去のデータのみを使った移動平均  
✅ カレンダー特徴量（日付から機械的に計算）  
✅ 予測時点で既知の外部データ（CM計画など）

---

## 📈 推奨される特徴量選択の優先順位

### Tier 1: 最重要（必須）
- `acc_get_cnt` (当日のアカウント取得数を使う場合は注意)
- `acc_lag1`, `acc_ma7` (ラグ版は安全)
- `cm_flg`, `cm_lag1`
- `is_open_day` (営業日フラグ)
- `month`, `dow`

### Tier 2: 重要
- `call_lag1`, `call_ma7`
- `cm_streak`, `cm_count_last7`
- `is_month_end`, `is_day_25`
- `is_pre_tax_increase_month` (2019年データの場合)
- `quarter`

### Tier 3: 有用
- `search_cnt`, `search_lag1w`
- `cm_x_q3`, `cm_x_acc_continuous`
- `is_golden_week`, `is_obon`, `is_new_year_period`
- `historical_volatility`

### Tier 4: 補助的
- 曜日のone-hot
- 月のone-hot
- 季節フラグ
- 非線形変換（`acc_squared`など）

---

## 🎯 仮定の検証方法

### 1. 単変量分析
- 各特徴量と目的変数の相関係数
- カテゴリ別の平均値差の検定（t検定、ANOVA）

### 2. 特徴量重要度
- Random Forestの特徴量重要度
- Permutation Importance
- SHAP値

### 3. 部分依存プロット
- 各特徴量の効果の可視化
- 非線形関係の確認

### 4. 交互作用の検証
- 2要因・3要因の交互作用項の有意性
- SHAP interaction values

---

## 📁 出力ファイル

- `airregi_features_generated.csv`: 142個の特徴量を追加したデータセット
- `airregi_hypothesis_features.md`: 本ドキュメント

---

*生成日: 2025年12月18日*  
*仮定数: 65個*  
*特徴量数: 142個*
